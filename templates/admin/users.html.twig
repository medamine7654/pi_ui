{% extends 'base.html.twig' %}

{% block title %}Utilisateurs - RentAdmin{% endblock %}

{% block search_placeholder %}Rechercher un utilisateur...{% endblock %}

{% block body %}
<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl font-bold text-dark font-heading">Utilisateurs</h1>
        <p class="text-gray-500 mt-1">Gérer les comptes utilisateurs et leurs rôles</p>
    </div>
    <div class="flex items-center gap-2">
        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">{{ active_users_count|default(6) }} actifs</span>
        <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium">{{ suspended_users_count|default(1) }} suspendus</span>
    </div>
</div>

<!-- Filters -->
<div class="bg-white rounded-xl shadow-sm p-4 mb-6">
    <form method="get" class="flex flex-col sm:flex-row gap-4">
        <div class="relative flex-1">
            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            <input type="text" 
                   name="search"
                   value="{{ app.request.query.get('search') }}"
                   placeholder="Rechercher un utilisateur..."
                   class="pl-10 w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
        </div>
        <div class="flex gap-2">
            <select name="role" class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                <option value="">Tous les rôles</option>
                <option value="admin" {% if app.request.query.get('role') == 'admin' %}selected{% endif %}>Administrateur</option>
                <option value="host" {% if app.request.query.get('role') == 'host' %}selected{% endif %}>Hôte</option>
                <option value="guest" {% if app.request.query.get('role') == 'guest' %}selected{% endif %}>Voyageur</option>
            </select>
            <select name="status" class="bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary">
                <option value="">Tous les statuts</option>
                <option value="active" {% if app.request.query.get('status') == 'active' %}selected{% endif %}>Actif</option>
                <option value="suspended" {% if app.request.query.get('status') == 'suspended' %}selected{% endif %}>Suspendu</option>
                <option value="pending" {% if app.request.query.get('status') == 'pending' %}selected{% endif %}>En attente</option>
            </select>
            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-lg text-sm hover:bg-primary/90 transition-colors">
                <i class="fas fa-filter"></i>
            </button>
        </div>
    </form>
</div>

<!-- Users Table -->
<div class="bg-white rounded-xl shadow-sm overflow-hidden">
    <div class="overflow-x-auto">
        <table class="w-full">
            <thead class="bg-gray-50 border-b border-gray-200">
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Utilisateur</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Rôle</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Statut</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Activité</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Signalements</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Risque</th>
                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200">
                {% for user in users|default([
                    { id: 'u1', name: 'Marie Dubois', email: 'marie.dubois@email.com', role: 'host', status: 'active', avatar: 'https://i.pravatar.cc/150?u=u1', bookingsCount: 45, listingsCount: 8, reportsCount: 0, riskScore: 15, cancellationRate: 2.1 },
                    { id: 'u2', name: 'Jean Martin', email: 'jean.martin@email.com', role: 'guest', status: 'active', avatar: 'https://i.pravatar.cc/150?u=u2', bookingsCount: 12, listingsCount: 0, reportsCount: 1, riskScore: 35, cancellationRate: 8.3 },
                    { id: 'u3', name: 'Sophie Bernard', email: 'sophie.bernard@email.com', role: 'host', status: 'suspended', avatar: 'https://i.pravatar.cc/150?u=u3', bookingsCount: 78, listingsCount: 15, reportsCount: 5, riskScore: 78, cancellationRate: 18.5 },
                    { id: 'u4', name: 'Lucas Petit', email: 'lucas.petit@email.com', role: 'guest', status: 'active', avatar: 'https://i.pravatar.cc/150?u=u4', bookingsCount: 8, listingsCount: 0, reportsCount: 0, riskScore: 5, cancellationRate: 0 },
                    { id: 'u5', name: 'Emma Roux', email: 'emma.roux@email.com', role: 'admin', status: 'active', avatar: 'https://i.pravatar.cc/150?u=u5', bookingsCount: 0, listingsCount: 0, reportsCount: 0, riskScore: 0, cancellationRate: 0 },
                    { id: 'u6', name: 'Thomas Moreau', email: 'thomas.moreau@email.com', role: 'host', status: 'active', avatar: 'https://i.pravatar.cc/150?u=u6', bookingsCount: 34, listingsCount: 5, reportsCount: 2, riskScore: 42, cancellationRate: 5.8 },
                ]) %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-3">
                                <img src="{{ user.avatar }}" alt="{{ user.name }}" class="w-10 h-10 rounded-full">
                                <div>
                                    <p class="font-medium text-dark">{{ user.name }}</p>
                                    <p class="text-sm text-gray-500">{{ user.email }}</p>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                {% if user.role == 'admin' %}
                                    <i class="fas fa-shield-alt text-gray-400"></i>
                                {% elseif user.role == 'host' %}
                                    <i class="fas fa-user text-gray-400"></i>
                                {% else %}
                                    <i class="fas fa-user-slash text-gray-400"></i>
                                {% endif %}
                                <span class="text-sm">
                                    {% if user.role == 'admin' %}Administrateur
                                    {% elseif user.role == 'host' %}Hôte
                                    {% else %}Voyageur{% endif %}
                                </span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            {% if user.status == 'active' %}
                                <span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-medium">Actif</span>
                            {% elseif user.status == 'suspended' %}
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium">Suspendu</span>
                            {% else %}
                                <span class="px-2 py-1 bg-yellow-100 text-yellow-700 rounded-full text-xs font-medium">En attente</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm">
                                <p>{{ user.bookingsCount }} réservations</p>
                                {% if user.listingsCount > 0 %}
                                    <p class="text-gray-500">{{ user.listingsCount }} annonces</p>
                                {% endif %}
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            {% if user.reportsCount > 0 %}
                                <span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-medium">{{ user.reportsCount }}</span>
                            {% else %}
                                <span class="px-2 py-1 bg-gray-100 text-gray-600 rounded-full text-xs font-medium">0</span>
                            {% endif %}
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center gap-2">
                                <div class="w-16 h-2 bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full rounded-full transition-all duration-500 
                                        {% if user.riskScore > 70 %}bg-red-500
                                        {% elseif user.riskScore > 40 %}bg-yellow-500
                                        {% else %}bg-green-500{% endif %}" 
                                         style="width: {{ user.riskScore }}%"></div>
                                </div>
                                <span class="text-xs font-medium {% if user.riskScore > 70 %}text-red-600{% elseif user.riskScore > 40 %}text-yellow-600{% else %}text-green-600{% endif %}">
                                    {{ user.riskScore }}%
                                </span>
                            </div>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <div class="relative inline-block">
                                <button class="p-2 hover:bg-gray-100 rounded-lg" onclick="toggleDropdown('user-dropdown-{{ user.id }}')">
                                    <i class="fas fa-ellipsis-h text-gray-400"></i>
                                </button>
                                <div id="user-dropdown-{{ user.id }}" class="hidden absolute right-0 top-full mt-1 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50">
                                    <a href="#" onclick="openUserModal('{{ user.id }}')" class="flex items-center gap-2 px-4 py-2 text-sm text-dark hover:bg-gray-50">
                                        <i class="fas fa-eye text-gray-400"></i>
                                        Voir détails
                                    </a>
                                    <form method="post" action="{{ path('admin_user_toggle_status', {id: user.id}) }}" class="block">
                                        <input type="hidden" name="_token" value="{{ csrf_token('toggle-status' ~ user.id) }}">
                                        <button type="submit" class="w-full flex items-center gap-2 px-4 py-2 text-sm {% if user.status == 'suspended' %}text-green-600{% else %}text-red-600{% endif %} hover:bg-gray-50 text-left">
                                            {% if user.status == 'suspended' %}
                                                <i class="fas fa-check-circle"></i>
                                                Réactiver
                                            {% else %}
                                                <i class="fas fa-ban"></i>
                                                Suspendre
                                            {% endif %}
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- User Details Modal -->
<div id="user-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-2xl w-full max-h-[90vh] overflow-auto">
        <div class="p-6 border-b border-gray-200 flex items-center justify-between">
            <h3 class="text-xl font-semibold text-dark">Détails de l'utilisateur</h3>
            <button onclick="closeUserModal()" class="p-2 hover:bg-gray-100 rounded-lg">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="p-6 space-y-6" id="user-modal-content">
            <!-- Content loaded via JS -->
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
<script>
const usersData = {{ users|default([
    { id: 'u1', name: 'Marie Dubois', email: 'marie.dubois@email.com', role: 'host', status: 'active', avatar: 'https://i.pravatar.cc/150?u=u1', joinedAt: '2023-01-15', lastActive: '2024-01-20', bookingsCount: 45, listingsCount: 8, reportsCount: 0, riskScore: 15, cancellationRate: 2.1 },
    { id: 'u2', name: 'Jean Martin', email: 'jean.martin@email.com', role: 'guest', status: 'active', avatar: 'https://i.pravatar.cc/150?u=u2', joinedAt: '2023-03-22', lastActive: '2024-01-19', bookingsCount: 12, listingsCount: 0, reportsCount: 1, riskScore: 35, cancellationRate: 8.3 },
    { id: 'u3', name: 'Sophie Bernard', email: 'sophie.bernard@email.com', role: 'host', status: 'suspended', avatar: 'https://i.pravatar.cc/150?u=u3', joinedAt: '2023-06-10', lastActive: '2024-01-15', bookingsCount: 78, listingsCount: 15, reportsCount: 5, riskScore: 78, cancellationRate: 18.5 },
    { id: 'u4', name: 'Lucas Petit', email: 'lucas.petit@email.com', role: 'guest', status: 'active', avatar: 'https://i.pravatar.cc/150?u=u4', joinedAt: '2023-08-05', lastActive: '2024-01-20', bookingsCount: 8, listingsCount: 0, reportsCount: 0, riskScore: 5, cancellationRate: 0 },
    { id: 'u5', name: 'Emma Roux', email: 'emma.roux@email.com', role: 'admin', status: 'active', avatar: 'https://i.pravatar.cc/150?u=u5', joinedAt: '2022-12-01', lastActive: '2024-01-20', bookingsCount: 0, listingsCount: 0, reportsCount: 0, riskScore: 0, cancellationRate: 0 },
    { id: 'u6', name: 'Thomas Moreau', email: 'thomas.moreau@email.com', role: 'host', status: 'active', avatar: 'https://i.pravatar.cc/150?u=u6', joinedAt: '2023-02-28', lastActive: '2024-01-18', bookingsCount: 34, listingsCount: 5, reportsCount: 2, riskScore: 42, cancellationRate: 5.8 },
])|json_encode|raw }};

function openUserModal(userId) {
    const user = usersData.find(u => u.id === userId);
    if (!user) return;
    
    const roleLabels = { admin: 'Administrateur', host: 'Hôte', guest: 'Voyageur' };
    const statusClass = { active: 'bg-green-100 text-green-700', suspended: 'bg-red-100 text-red-700', pending: 'bg-yellow-100 text-yellow-700' };
    
    document.getElementById('user-modal-content').innerHTML = `
        <div class="flex items-center gap-4">
            <img src="${user.avatar}" alt="${user.name}" class="w-20 h-20 rounded-full">
            <div>
                <h4 class="text-xl font-semibold text-dark">${user.name}</h4>
                <p class="text-gray-500">${user.email}</p>
                <div class="flex items-center gap-2 mt-2">
                    <span class="px-2 py-1 rounded-full text-xs font-medium ${statusClass[user.status]}">${user.status === 'active' ? 'Actif' : user.status === 'suspended' ? 'Suspendu' : 'En attente'}</span>
                    <span class="px-2 py-1 border border-gray-200 rounded-full text-xs">${roleLabels[user.role]}</span>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-500">Inscrit le</p>
                <p class="font-medium">${new Date(user.joinedAt).toLocaleDateString('fr-FR')}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-500">Dernière activité</p>
                <p class="font-medium">${new Date(user.lastActive).toLocaleDateString('fr-FR')}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-500">Réservations</p>
                <p class="font-medium">${user.bookingsCount}</p>
            </div>
            <div class="bg-gray-50 rounded-lg p-4">
                <p class="text-sm text-gray-500">Taux d'annulation</p>
                <p class="font-medium ${user.cancellationRate > 10 ? 'text-red-600' : 'text-green-600'}">${user.cancellationRate}%</p>
            </div>
        </div>
        <div>
            <p class="text-sm text-gray-500 mb-2">Score de risque</p>
            <div class="flex items-center gap-4">
                <div class="flex-1 h-3 bg-gray-100 rounded-full overflow-hidden">
                    <div class="h-full rounded-full ${user.riskScore > 70 ? 'bg-red-500' : user.riskScore > 40 ? 'bg-yellow-500' : 'bg-green-500'}" style="width: ${user.riskScore}%"></div>
                </div>
                <span class="font-medium ${user.riskScore > 70 ? 'text-red-600' : user.riskScore > 40 ? 'text-yellow-600' : 'text-green-600'}">${user.riskScore}/100</span>
            </div>
        </div>
        ${user.reportsCount > 0 ? `
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
            <div class="flex items-center gap-2 text-red-700">
                <i class="fas fa-exclamation-triangle"></i>
                <span class="font-medium">${user.reportsCount} signalement(s)</span>
            </div>
        </div>
        ` : ''}
    `;
    
    document.getElementById('user-modal').classList.remove('hidden');
}

function closeUserModal() {
    document.getElementById('user-modal').classList.add('hidden');
}

// Close modal on backdrop click
document.getElementById('user-modal').addEventListener('click', function(e) {
    if (e.target === this) closeUserModal();
});
</script>
{% endblock %}
