{% extends 'base.html.twig' %}

{% block title %}Analytics - RentAdmin{% endblock %}

{% block body %}
<!-- Page Header -->
<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
    <div>
        <h1 class="text-2xl font-bold text-dark font-heading">Analytics</h1>
        <p class="text-gray-500 mt-1">Statistiques et indicateurs de performance</p>
    </div>
    <div class="flex items-center gap-2">
        {% set ranges = {'7d': '7 jours', '30d': '30 jours', '90d': '3 mois', '1y': '1 an'} %}
        {% for key, label in ranges %}
            <a href="?range={{ key }}" class="px-3 py-1.5 text-sm rounded-lg {% if app.request.query.get('range', '30d') == key %}bg-primary text-white{% else %}border border-gray-200 hover:bg-gray-50{% endif %}">
                {{ label }}
            </a>
        {% endfor %}
    </div>
</div>

<!-- KPI Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
    {% set kpis = [
        { title: 'Revenus totaux', value: '45,680€', change: 5.2, icon: 'fa-euro-sign', color: 'secondary' },
        { title: 'Réservations', value: '5,678', change: 12.5, icon: 'fa-calendar', color: 'primary' },
        { title: 'Nouveaux utilisateurs', value: '156', change: 8.3, icon: 'fa-users', color: 'dark' },
        { title: 'Taux d\'annulation', value: '4.2%', change: -2.1, icon: 'fa-flag', color: 'primary', is_negative_good: true },
    ] %}
    
    {% for kpi in kpis %}
        <div class="bg-white rounded-xl p-6 shadow-sm hover:shadow-md transition-all duration-300 relative overflow-hidden group">
            <div class="absolute top-0 right-0 w-24 h-24 opacity-10 rounded-bl-full bg-{{ kpi.color }}"></div>
            <div class="flex items-center justify-between">
                <div class="p-3 rounded-lg bg-{{ kpi.color }}/10">
                    <i class="fas {{ kpi.icon }} text-{{ kpi.color }}"></i>
                </div>
                <div class="flex items-center gap-1 text-sm font-medium {% if (kpi.is_negative_good|default(false) and kpi.change > 0) or (not kpi.is_negative_good|default(false) and kpi.change < 0) %}text-red-600{% else %}text-green-600{% endif %}">
                    <i class="fas fa-arrow-{{ kpi.change > 0 ? 'up' : 'down' }}"></i>
                    <span>{{ kpi.change|abs }}%</span>
                </div>
            </div>
            <div class="mt-4">
                <p class="text-2xl font-bold text-dark">{{ kpi.value }}</p>
                <p class="text-sm text-gray-500">{{ kpi.title }}</p>
            </div>
        </div>
    {% endfor %}
</div>

<!-- Charts Row -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
    <!-- Revenue Chart -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-dark mb-4 flex items-center gap-2">
            <i class="fas fa-chart-bar"></i>
            Évolution des revenus
        </h3>
        <div class="h-48 flex items-end justify-between gap-2">
            {% set revenue_data = [
                { label: 'Juil', value: 42000 },
                { label: 'Août', value: 45000 },
                { label: 'Sep', value: 48000 },
                { label: 'Oct', value: 52000 },
                { label: 'Nov', value: 55000 },
                { label: 'Déc', value: 45680 },
            ] %}
            {% set max_revenue = 60000 %}
            {% for item in revenue_data %}
                <div class="flex-1 flex flex-col items-center gap-2">
                    <div class="w-full relative">
                        <div class="w-full rounded-t-md bg-secondary transition-all duration-500 hover:opacity-80" 
                             style="height: {{ (item.value / max_revenue) * 160 }}px; opacity: {{ 0.8 + (loop.index / revenue_data|length) * 0.2 }}"></div>
                        <div class="absolute -top-5 left-1/2 -translate-x-1/2 text-xs font-medium">{{ (item.value / 1000)|round }}k</div>
                    </div>
                    <span class="text-xs text-gray-500">{{ item.label }}</span>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Bookings Chart -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-dark mb-4 flex items-center gap-2">
            <i class="fas fa-chart-line"></i>
            Réservations vs Locations
        </h3>
        <div class="space-y-4">
            <div>
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-600">Services</span>
                    <span class="text-sm font-medium text-secondary">468</span>
                </div>
                <svg viewBox="0 0 100 50" class="w-full h-24" preserveAspectRatio="none">
                    <defs>
                        <linearGradient id="gradient-secondary" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stop-color="#00A699" stop-opacity="0.3" />
                            <stop offset="100%" stop-color="#00A699" stop-opacity="0" />
                        </linearGradient>
                    </defs>
                    <polygon points="0,50 0,35 20,30 40,25 60,20 80,15 100,10 100,50" fill="url(#gradient-secondary)" />
                    <polyline points="0,35 20,30 40,25 60,20 80,15 100,10" fill="none" stroke="#00A699" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
            <div>
                <div class="flex items-center justify-between mb-2">
                    <span class="text-sm text-gray-600">Matériel</span>
                    <span class="text-sm font-medium text-primary">285</span>
                </div>
                <svg viewBox="0 0 100 50" class="w-full h-24" preserveAspectRatio="none">
                    <defs>
                        <linearGradient id="gradient-primary" x1="0%" y1="0%" x2="0%" y2="100%">
                            <stop offset="0%" stop-color="#FF5A5F" stop-opacity="0.3" />
                            <stop offset="100%" stop-color="#FF5A5F" stop-opacity="0" />
                        </linearGradient>
                    </defs>
                    <polygon points="0,50 0,40 20,38 40,35 60,30 80,25 100,20 100,50" fill="url(#gradient-primary)" />
                    <polyline points="0,40 20,38 40,35 60,30 80,25 100,20" fill="none" stroke="#FF5A5F" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
            </div>
        </div>
        <div class="flex items-center justify-center gap-6 mt-4">
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-secondary"></div>
                <span class="text-sm text-gray-600">Services</span>
            </div>
            <div class="flex items-center gap-2">
                <div class="w-3 h-3 rounded-full bg-primary"></div>
                <span class="text-sm text-gray-600">Matériel</span>
            </div>
        </div>
    </div>
</div>

<!-- Leaderboards -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
    <!-- Top Hosts -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-dark mb-4">Top Hôtes</h3>
        <div class="space-y-3">
            {% for host in top_hosts|default([
                { name: 'Marie Dubois', bookingsCount: 45, listingsCount: 8 },
                { name: 'Thomas Moreau', bookingsCount: 34, listingsCount: 5 },
                { name: 'Nicolas Fournier', bookingsCount: 28, listingsCount: 10 },
                { name: 'Sophie Bernard', bookingsCount: 78, listingsCount: 15 },
            ]) %}
                <div class="flex items-center gap-3">
                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold {% if loop.index == 1 %}bg-yellow-100 text-yellow-700{% elseif loop.index == 2 %}bg-gray-100 text-gray-700{% elseif loop.index == 3 %}bg-orange-100 text-orange-700{% else %}bg-gray-50 text-gray-500{% endif %}">
                        {{ loop.index }}
                    </span>
                    <div class="flex-1">
                        <p class="font-medium text-sm">{{ host.name }}</p>
                        <p class="text-xs text-gray-500">{{ host.bookingsCount }} réservations</p>
                    </div>
                    <span class="px-2 py-1 bg-green-100 text-green-700 rounded text-xs">{{ host.listingsCount }} annonces</span>
                </div>
            {% endfor %}
        </div>
    </div>

    <!-- Most Reported -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-red-600 mb-4">Plus signalés</h3>
        <div class="space-y-3">
            {% for user in most_reported|default([
                { name: 'Sophie Bernard', reportsCount: 5, riskScore: 78 },
                { name: 'Thomas Moreau', reportsCount: 2, riskScore: 42 },
                { name: 'Jean Martin', reportsCount: 1, riskScore: 35 },
            ]) %}
                <div class="flex items-center gap-3">
                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold {% if loop.index == 1 %}bg-red-100 text-red-700{% else %}bg-gray-50 text-gray-500{% endif %}">
                        {{ loop.index }}
                    </span>
                    <div class="flex-1">
                        <p class="font-medium text-sm">{{ user.name }}</p>
                        <p class="text-xs text-gray-500">{{ user.reportsCount }} signalements</p>
                    </div>
                    <span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs">{{ user.riskScore }}% risque</span>
                </div>
            {% else %}
                <p class="text-gray-500 text-center py-4">Aucun utilisateur signalé</p>
            {% endfor %}
        </div>
    </div>

    <!-- High Cancellation -->
    <div class="bg-white rounded-xl shadow-sm p-6">
        <h3 class="text-lg font-semibold text-orange-600 mb-4">Taux d'annulation élevé</h3>
        <div class="space-y-3">
            {% for user in high_cancellation|default([
                { name: 'Sophie Bernard', cancellationRate: 18.5 },
                { name: 'Jean Martin', cancellationRate: 8.3 },
                { name: 'Thomas Moreau', cancellationRate: 5.8 },
            ]) %}
                <div class="flex items-center gap-3">
                    <span class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold {% if loop.index == 1 %}bg-orange-100 text-orange-700{% else %}bg-gray-50 text-gray-500{% endif %}">
                        {{ loop.index }}
                    </span>
                    <div class="flex-1">
                        <p class="font-medium text-sm">{{ user.name }}</p>
                        <p class="text-xs text-gray-500">{{ user.cancellationRate }}% de ses réservations</p>
                    </div>
                    <div class="w-16 h-2 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full bg-orange-500 rounded-full" style="width: {{ user.cancellationRate * 5 }}%"></div>
                    </div>
                </div>
            {% else %}
                <p class="text-gray-500 text-center py-4">Aucun utilisateur concerné</p>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Platform Health -->
<div class="bg-white rounded-xl shadow-sm p-6">
    <h3 class="text-lg font-semibold text-dark mb-4">Santé de la plateforme</h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
        {% set health_metrics = [
            { label: 'Services actifs', value: 1234, total: 1244, color: 'primary' },
            { label: 'Matériel disponible', value: 892, total: 892, color: 'secondary' },
            { label: 'Utilisateurs actifs', value: 7, total: 8, color: 'dark' },
            { label: 'Réservations complétées', value: 3, total: 6, color: 'secondary' },
        ] %}
        
        {% for metric in health_metrics %}
            <div class="space-y-2">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">{{ metric.label }}</span>
                    <span class="font-medium">{{ metric.value }}/{{ metric.total }}</span>
                </div>
                <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                    <div class="h-full rounded-full transition-all duration-500 bg-{{ metric.color }}" style="width: {{ (metric.value / metric.total) * 100 }}%"></div>
                </div>
                <p class="text-xs text-gray-500">{{ ((metric.value / metric.total) * 100)|number_format(1) }}% actif</p>
            </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
